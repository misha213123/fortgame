import sqlite3
import os
import random

def get_random_challenge():
    db_path = os.path.join(os.path.dirname(__file__), 'questions.db')
    conn = sqlite3.connect(db_path, check_same_thread=False)
    cursor = conn.cursor()
    cursor.execute("SELECT question, options, answer, hint FROM questions ORDER BY RANDOM() LIMIT 1")
    challenge = cursor.fetchone()
    conn.close()

    if challenge:
        question, options, answer, hint = challenge
        options = options.split('|')  # Предполагается, что варианты ответа хранятся в одной строке, разделённой |
        return {"question": question, "options": options, "answer": answer, "hint": hint}
    else:
        return None

def get_hint_for_challenge(challenge):
    return challenge["hint"]

def load_fort_boyard_data(user_id):
    db_path = os.path.join(os.path.dirname(__file__), 'users.db')
    conn = sqlite3.connect(db_path, check_same_thread=False)
    cursor = conn.cursor()
    cursor.execute("SELECT stage, coins FROM fort_boyard WHERE user_id = ?", (user_id,))
    data = cursor.fetchone()
    conn.close()

    if data:
        return data[0], data[1]
    else:
        return 0, 0

def save_fort_boyard_data(user_id, stage, coins):
    db_path = os.path.join(os.path.dirname(__file__), 'users.db')
    conn = sqlite3.connect(db_path, check_same_thread=False)
    cursor = conn.cursor()
    cursor.execute("INSERT OR REPLACE INTO fort_boyard (user_id, stage, coins) VALUES (?, ?, ?)", (user_id, stage, coins))
    conn.commit()
    conn.close()

def pass_challenge(user_id, selected_option, challenge):
    stage, coins = load_fort_boyard_data(user_id)

    print(f"Selected option: {selected_option}")
    print(f"Correct answer: {challenge['answer']}")

    if selected_option == challenge["answer"]:
        stage += 1
        coins += 10  # Награда за успешное прохождение испытания
        save_fort_boyard_data(user_id, stage, coins)
        return True, "Верно! Вы успешно прошли испытание. Переходим к следующему.", stage, coins
    else:
        return False, "Неправильно. Попробуйте снова.", stage, coins

# Инициализация базы данных вопросов
def initialize_questions_db():
    db_path = os.path.join(os.path.dirname(__file__), 'questions.db')
    conn = sqlite3.connect(db_path, check_same_thread=False)
    cursor = conn.cursor()
    
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS questions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        question TEXT NOT NULL,
        options TEXT NOT NULL,
        answer TEXT NOT NULL,
        hint TEXT NOT NULL
    )
    ''')

    # Пример добавления вопросов
    sample_questions = [
        ("Сколько игроков в команде в классическом Форт Боярд?", "4|6|8", "6", "Больше пяти, меньше семи."),
        ("Какая страна является родиной Форта Боярд?", "Франция|Италия|Испания", "Франция", "Эта страна известна своей Эйфелевой башней."),
        ("Какой океан омывает берега Форта Боярд?", "Атлантический|Тихий|Индийский", "Атлантический", "Этот океан находится на западе от Европы."),
        ("Какой цвет является основным в логотипе Форта Боярд?", "Красный|Золотой|Синий", "Золотой", "Цвет драгоценного металла."),
        ("Какая известная личность является ведущим Форта Боярд?", "Оливье Мин|Жан-Пьер Кастальди|Паскаль Ольмета", "Оливье Мин", "Его имя начинается с 'О'."),
        ("Сколько сезонов классического Форта Боярд?", "20|25|30", "30", "Больше двадцати, меньше тридцати одного."),
        ("Какое испытание в Форт Боярд включает в себя лабиринт?", "Лабиринт с крысами|Испытание на баланс|Комната страха", "Лабиринт с крысами", "Это испытание связано с маленькими грызунами."),
        ("Какая река находится ближе всего к Форту Боярд?", "Сена|Лауренс|Гаронна", "Сена", "Эта река протекает через Париж."),
        ("Как называется музыкальная тема Форта Боярд?", "The Quest|Adventure|The Challenge", "The Quest", "Название связано с поисками."),
        ("Какие животные часто встречаются в испытаниях Форта Боярд?", "Тигры|Крысы|Обезьяны", "Крысы", "Это маленькие грызуны, которые любят сыр."),
        ("Какой ведущий в Форт Боярд был первым?", "Патрис Лаффон|Оливье Мин|Жан-Пьер Кастальди", "Патрис Лаффон", "Его имя начинается с 'П'."),
        ("Как называется испытание, в котором участники должны искать ключи в воде?", "Подводный поиск|Водный лабиринт|Купание с акулами", "Подводный поиск", "Участники ищут ключи под водой."),
        ("Какой цвет носит одежда участников Форта Боярд?", "Красный|Синий|Зеленый", "Синий", "Цвет неба."),
        ("Какой инструмент используется для поиска ключей в испытаниях Форта Боярд?", "Компас|Фонарик|Металлоискатель", "Металлоискатель", "Используется для поиска металлических предметов."),
        ("Сколько времени длится одно испытание в Форт Боярд?", "1 минута|2 минуты|3 минуты", "3 минуты", "Больше двух минут."),
        ("Как называется испытание, в котором участники должны преодолевать препятствия на высоте?", "Воздушный путь|Канатный мост|Вершина", "Канатный мост", "Это испытание включает веревки."),
        ("Какие предметы участники собирают во время испытаний в Форт Боярд?", "Ключи|Монеты|Бриллианты", "Ключи", "Используются для открытия дверей."),
        ("Какое транспортное средство используется для доставки участников на Форт Боярд?", "Корабль|Вертолет|Подводная лодка", "Корабль", "Плавает по воде."),
        ("Какая часть тела чаще всего задействована в испытаниях Форта Боярд?", "Руки|Ноги|Голова", "Руки", "Используются для захвата и удержания."),
        ("Сколько подсказок могут получить участники в Форт Боярд?", "2|3|4", "3", "Больше двух, меньше четырех."),
        ("Какой вид спорта чаще всего используется в испытаниях Форта Боярд?", "Бег|Плавание|Лазание", "Лазание", "Связано с использованием рук и ног."),
        ("Какая часть Форта Боярд является самой высокой?", "Башня|Стена|Мост", "Башня", "Находится на вершине."),
        ("Как называется испытание, в котором участники должны держать баланс на узкой поверхности?", "Балансировка|Хождение по канату|Ловушка", "Хождение по канату", "Узкая поверхность."),
        ("Какой известный символ находится на вершине Форта Боярд?", "Флаг|Статуя|Светильник", "Флаг", "Развивается на ветру."),
        ("Какое животное часто используется в испытаниях Форта Боярд?", "Змея|Крыса|Птица", "Крыса", "Маленький грызун."),
        ("Какое время суток чаще всего показывается в Форт Боярд?", "Утро|День|Ночь", "День", "Самое яркое время суток."),
        ("Как называется испытание, в котором участники должны пройти через воду?", "Плавание|Подводный путь|Водная ловушка", "Подводный путь", "Проходят под водой."),
        ("Какой цвет используется для обозначения ключей в Форт Боярд?", "Красный|Золотой|Синий", "Золотой", "Цвет драгоценного металла."),
        ("Как называется место, где участники получают подсказки?", "Комната подсказок|Зал тайны|Кабинет загадок", "Комната подсказок", "Место, где получают подсказки."),
        ("Какой инструмент используется для подсказок в Форт Боярд?", "Ключ|Карта|Книга", "Книга", "Используется для чтения."),
        ("Какая задача стоит перед участниками в финале Форт Боярд?", "Найти сокровище|Собрать монеты|Открыть двери", "Найти сокровище", "Главная цель игры."),
        ("Как называется испытание, в котором участники должны пройти через лабиринт?", "Лабиринт страха|Запутанный путь|Лабиринт испытаний", "Лабиринт испытаний", "Запутанный путь."),
        ("Какой цвет используется для обозначения опасности в Форт Боярд?", "Красный|Зеленый|Синий", "Красный", "Цвет, предупреждающий об опасности."),
        ("Какая часть Форта Боярд является самой защищенной?", "Хранилище|Башня|Стена", "Хранилище", "Место для хранения ценностей."),
        ("Как называется испытание, в котором участники должны подняться на вершину?", "Восхождение|Подъем|Забег", "Восхождение", "Процесс подъема."),
        ("Какие предметы участники используют для защиты в испытаниях?", "Шлемы|Перчатки|Костюмы", "Шлемы", "Защищают голову."),
        ("Какой вид транспорта чаще всего используется для испытаний на воде?", "Лодка|Каяк|Плот", "Лодка", "Плавает по воде."),
        ("Какая часть Форта Боярд чаще всего используется для испытаний на высоте?", "Башня|Стена|Крыша", "Башня", "Находится на вершине."),
        ("Какой цвет чаще всего используется для обозначения ключей в испытаниях?", "Золотой|Серебряный|Бронзовый", "Золотой", "Цвет драгоценного металла."),
        ("Какая задача стоит перед участниками в начале игры?", "Найти ключи|Собрать команду|Пройти обучение", "Найти ключи", "Основная цель игры."),
        ("Как называется испытание, в котором участники должны пройти через огонь?", "Огненный путь|Испытание огнем|Огненная ловушка", "Испытание огнем", "Связано с огнем."),
        ("Какой цвет чаще всего используется для обозначения воды в испытаниях?", "Синий|Зеленый|Белый", "Синий", "Цвет воды."),
        ("Как называется место, где участники отдыхают между испытаниями?", "Комната отдыха|Зона отдыха|Лагерь", "Комната отдыха", "Место для отдыха."),
        ("Какая часть тела чаще всего используется в испытаниях на ловкость?", "Руки|Ноги|Голова", "Руки", "Используются для захвата и удержания."),
        ("Какой вид спорта чаще всего используется в испытаниях на скорость?", "Бег|Плавание|Велоспорт", "Бег", "Связан с быстрым передвижением."),
        ("Какая часть Форта Боярд используется для испытаний на силу?", "Камера силы|Зал мощи|Комната крепости", "Камера силы", "Место для испытаний на силу."),
        ("Какой инструмент используется для измерения времени в испытаниях?", "Часы|Таймер|Секундомер", "Секундомер", "Используется для измерения времени."),
        ("Как называется испытание, в котором участники должны пройти через темные туннели?", "Темный путь|Туннель страха|Туннель испытаний", "Туннель страха", "Связано с темнотой и страхом."),
    ]

    cursor.executemany("INSERT INTO questions (question, options, answer, hint) VALUES (?, ?, ?, ?)", sample_questions)
    conn.commit()
    conn.close()

initialize_questions_db()
